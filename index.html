<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quadro Branco — Entregas v4 (histórico vivo, somente visualização)</title>
  <meta name="description" content="Viewer estático do controle de obra. Sem botões. Renderiza snapshot a partir de um JSON com histórico de eventos (schema v4). Dois quadros: Elétrica e Hidráulica." />
  <style>
    :root{
      --bg:#ffffff; --text:#0f172a; --muted:#475569; --line:#e2e8f0; --head:#f8fafc;
      --ok:#16a34a; --pl:#eab308; --pm:#f97316; --nc:#ef4444; --nv:#cbd5e1;
      --badge:#ffffff; --badgeText:#0f172a;
    }
    *{box-sizing:border-box}
    html,body{margin:0;min-height:100%;background:var(--bg);color:var(--text);font:16px/1.35 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:12px 16px;border-bottom:2px solid var(--line);position:sticky;top:0;background:var(--bg);z-index:10}
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .brand img{height:36px;width:auto;object-fit:contain}
    .brand h1{margin:0;font-size:20px;font-weight:800;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .wrap{display:grid;grid-template-columns:1fr 1fr;gap:20px;padding:18px}
    .sectionTitle{grid-column:1 / -1; margin:8px 0 0 0; font-size:18px; font-weight:800; color:#0f172a}
    .card{border:2px solid var(--line);border-radius:18px;padding:14px}
    .card h2{margin:0 0 8px 0;font-size:16px}
    .kpi{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 10px 0}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:14px;color:var(--muted);background:var(--head)}
    .grid{display:grid;grid-template-columns:76px repeat(4,1fr);gap:8px}
    .cell,.head{border:1px solid var(--line);border-radius:12px;padding:0;text-align:center}
    .head{background:var(--head);font-weight:700;padding:10px}
    .apto{position:relative;height:48px;display:flex;align-items:center;justify-content:center;font-weight:800;border-width:2px;user-select:none}
    .apto .label{font-size:14px;background:rgba(255,255,255,.85);padding:2px 6px;border-radius:8px;mix-blend-mode:screen}
    .badge{position:absolute;top:6px;right:6px;background:var(--badge);color:var(--badgeText);border:1px solid var(--line);border-radius:10px;font-size:11px;padding:1px 6px;font-weight:800}
    .apto.nv{background:var(--nv);color:#0f172a}
    .apto.ok{background:var(--ok);color:#0b1610}
    .apto.pl{background:var(--pl);color:#3a2c07}
    .apto.pm{background:var(--pm);color:#fff}
    .apto.nc{background:var(--nc);color:#fff}
    .apto.disabled{background:transparent;border:1px dashed var(--line);color:var(--muted)}
    .apto.disabled .label{background:transparent}
    .tickets{margin-top:12px;border-top:1px dashed var(--line);padding-top:10px}
    .tickets h3{margin:0 0 8px 0;font-size:14px;color:var(--muted)}
    .ticket{display:flex;gap:8px;align-items:flex-start;border:1px solid var(--line);border-radius:10px;padding:8px;margin:6px 0;background:var(--head)}
    .tid{font-weight:800;color:#0f172a;background:#fff;border:1px solid var(--line);border-radius:8px;padding:2px 6px}
    .tmeta{font-size:12px;color:#64748b}
    .ttext{flex:1}

    footer{border-top:2px solid var(--line);padding:8px 14px 24px 14px;color:var(--muted);font-size:13px}
    .legend{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;opacity:.95}
    .dot{width:12px;height:12px;border-radius:3px;display:inline-block;margin-right:6px}
    .legend small{font-size:12px;color:#64748b}
    .legendTickets{margin-top:12px;border-top:1px dashed var(--line);padding-top:10px}
    .legendTickets h4{margin:0 0 8px 0;color:#334155}
    .legendTickets ul{margin:0;padding-left:18px}
    .aside{grid-column:1 / -1;border-top:2px dashed var(--line);padding:12px 0 0 0;margin-top:8px}
    .aside h3{margin:0 0 8px 0;font-size:14px;color:#334155}
    .aside .meta{font-size:12px;color:#64748b}
    .aside pre{white-space:pre-wrap;word-wrap:break-word;background:#f1f5f9;border:1px solid var(--line);padding:8px;border-radius:10px;max-height:260px;overflow:auto}

    @media (min-width:1600px){ html{font-size:18px} .apto{height:54px} }
    @media (min-width:2400px){ html{font-size:22px} .apto{height:60px} }
    @media print{ header{display:none} .card{break-inside:avoid} footer{display:none} }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img alt="Logo" src="Assets/logo.jpg?v=build" onerror="this.style.display='none'"/>
      <h1>Quadro Branco — Entregas (Histórico vivo, somente visualização)</h1>
    </div>
  </header>

  <main class="wrap" id="wrap">
    <h2 class="sectionTitle">Equipe Elétrica</h2>
    <!-- Cartões de Elétrica renderizados via JS -->
    <h2 class="sectionTitle">Equipe Hidráulica</h2>
    <!-- Cartões de Hidráulica renderizados via JS -->

    <section class="aside" id="aside">
      <h3>Histórico recente</h3>
      <div class="meta">Carregado do JSON embutido</div>
      <pre>—</pre>
      <div class="meta" id="selftests">Self-tests: executando…</div>
    </section>
  </main>

  <footer>
    <div class="legend">
      <span><span class="dot" style="background:var(--ok)"></span><strong>OK</strong> <small>entregue</small></span>
      <span><span class="dot" style="background:var(--pl)"></span><strong>PL</strong> <small>pendência leve</small></span>
      <span><span class="dot" style="background:var(--pm)"></span><strong>PM</strong> <small>pendência média</small></span>
      <span><span class="dot" style="background:var(--nc)"></span><strong>NC</strong> <small>não conforme</small></span>
      <span><span class="dot" style="background:var(--nv)"></span><strong>NV</strong> <small>não vistoriado</small></span>
    </div>
    <div class="legendTickets" id="legendTickets"></div>
  </footer>

  <!-- Bundle zerado: sem histórico, sem chamados; tudo NV por padrão -->
  <script id="DATA_JSON" type="application/json">{
    "schema":"v4",
    "version":1,
    "meta":{"createdAt":null,"updatedAt":null,"author":""},
    "snapshot":{"current":"eletrica","quadros":{"eletrica":{"nome":"Equipe Elétrica","blocos":{"Bloco 1":[],"Bloco 2":[]},"chamados":[]},"hidraulica":{"nome":"Equipe Hidráulica","blocos":{"Bloco 1":[],"Bloco 2":[]},"chamados":[]}}},
    "history":[],
    "__embedded": true
  }</script>
  <script>
    // ---- Config estática (somente visualização) ----
    const PAV=21, APT=4, LABEL={nv:"NV",ok:"OK",pl:"PL",pm:"PM",nc:"NC",xx:"--"};
    const aptosNoPav = i=> (PAV-i)===21?2:4;
    const aptNumber=(p,a)=>`${p}${(a+1).toString().padStart(2,'0')}`;
    const emptyMatriz=()=>Array.from({length:PAV},(_,i)=>Array.from({length:APT},(_,a)=>a<aptosNoPav(i)?'nv':'xx'));
    const byId = id=>document.getElementById(id);
    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

    function defaultBundle(){
      return {
        schema:'v4', version:1,
        meta:{ createdAt:null, updatedAt:null, author:'' },
        snapshot:{ current:'eletrica', quadros:{
          eletrica:{ nome:'Equipe Elétrica', blocos:{ 'Bloco 1':emptyMatriz(), 'Bloco 2':emptyMatriz() }, chamados:[] },
          hidraulica:{ nome:'Equipe Hidráulica', blocos:{ 'Bloco 1':emptyMatriz(), 'Bloco 2':emptyMatriz() }, chamados:[] }
        }},
        history:[], __embedded:true
      };
    }

    function dedupEvents(events){
      const seen=new Set(), arr=[];
      for(const e of (events||[])){
        if(!e||typeof e!=="object") continue;
        const id=e.id||`${e.type}-${e.ts}`;
        if(seen.has(id)) continue; seen.add(id);
        arr.push({ id, ts:e.ts||'', who:e.who||'', type:e.type, data:e.data });
      }
      arr.sort((a,b)=> (a.ts<b.ts? -1 : a.ts>b.ts? 1 : 0));
      return arr;
    }

    function applyEvents(snapshot, events){
      const s=snapshot;
      for(const key of ['eletrica','hidraulica']){
        if(!s.quadros[key]) s.quadros[key]={ nome:key, blocos:{}, chamados:[] };
        for(const b of ['Bloco 1','Bloco 2']){
          if(!Array.isArray(s.quadros[key].blocos[b])) s.quadros[key].blocos[b]=emptyMatriz();
        }
        if(!Array.isArray(s.quadros[key].chamados)) s.quadros[key].chamados=[];
      }
      (events||[]).forEach(ev=>{
        const {type,data}=ev||{};
        if(type==='setStatus'){
          const { quadro, bloco, pavIndex, aptIndex, to } = data||{};
          const q=s.quadros[quadro];
          if(q && q.blocos[bloco] && q.blocos[bloco][pavIndex] && q.blocos[bloco][pavIndex][aptIndex]!=null && ['nv','ok','pl','pm','nc'].includes(to)){
            q.blocos[bloco][pavIndex][aptIndex]=to;
          }
        } else if(type==='addChamado'){
          const { quadro, chamado } = data||{}; const q=s.quadros[quadro];
          if(q && chamado && chamado.id){ if(!q.chamados.some(c=>c.id===chamado.id)){ q.chamados.push(chamado); } }
        } else if(type==='delChamado'){
          const { quadro, id } = data||{}; const q=s.quadros[quadro];
          if(q){ q.chamados = (q.chamados||[]).filter(c=>c.id!==id); }
        }
      });
      return s;
    }

    function normalizeBundle(b){
      const base=defaultBundle();
      try{
        const out={...base};
        out.meta={ ...base.meta, ...(b.meta||{}) };
        out.version=Number.isFinite(b.version)?b.version:1;
        out.schema='v4';
        out.snapshot=JSON.parse(JSON.stringify(base.snapshot));
        const events = dedupEvents(Array.isArray(b.history)? b.history : []);
        applyEvents(out.snapshot, events);
        out.history=events;
        out.__embedded = true;
        return out;
      }catch(_){ return base; }
    }

    function chip(t){return `<span class="chip">${t}</span>`}
    function head(t){const d=document.createElement('div'); d.className='head cell'; d.textContent=t; return d;}
    function count(m){const r={ok:0,pl:0,pm:0,nc:0,nv:0,xx:0}; (m||[]).flat().forEach(s=>{if(r[s]!=null) r[s]++;}); return r;}

    function render(){
      const wrap = byId('wrap');
      wrap.querySelectorAll('.card').forEach(el=>el.remove());

      const dataTag=document.getElementById('DATA_JSON');
      let raw; try{ raw = dataTag && dataTag.textContent ? JSON.parse(dataTag.textContent) : defaultBundle(); }catch(e){ raw=defaultBundle(); console.error('JSON inválido no DATA_JSON:', e); }
      const bundle = normalizeBundle(raw);

      function renderQuadro(quadroKey){
        const q=bundle.snapshot.quadros[quadroKey];
        for(const [nome,matriz] of Object.entries(q.blocos)){
          const card=document.createElement('section'); card.className='card';
          const h2=document.createElement('h2'); h2.textContent=`${q.nome} — ${nome}`; card.appendChild(h2);
          const kpi=document.createElement('div'); kpi.className='kpi'; const s=count(matriz);
          kpi.innerHTML=[chip(`OK: ${s.ok}`),chip(`PL: ${s.pl}`),chip(`PM: ${s.pm}`),chip(`NC: ${s.nc}`),chip(`NV: ${s.nv}`)].join('');
          card.appendChild(kpi);
          const grid=document.createElement('div'); grid.className='grid';
          grid.appendChild(head('Pav'));
          for(let a=1;a<=4;a++) grid.appendChild(head(String(a).padStart(2,'0')));
          for(let i=0;i<21;i++){
            const pav=(21-i).toString().padStart(2,'0');
            grid.appendChild(head(pav));
            const valid=((21-i)===21?2:4);
            for(let a=0;a<4;a++){
              const st=matriz[i][a];
              const num=`${21-i}${(a+1).toString().padStart(2,'0')}`;
              const disabled=(a>=valid)||st==='xx';
              const d=document.createElement('div');
              d.className=`cell apto ${disabled?'disabled':st}`;
              d.title=disabled?`Pav ${pav} • Inexistente`:`Apto ${num} • ${LABEL[st]}`;
              d.innerHTML=`<span class="label">${disabled?'\u2014':`${num} · ${LABEL[st]}`}</span>`;
              const list=(bundle.snapshot.quadros[quadroKey].chamados||[]).filter(c=>c.bloco===nome && c.pavIndex===i && c.aptIndex===a);
              if(!disabled && list.length){ const b=document.createElement('div'); b.className='badge'; b.textContent=list.length===1?list[0].id:`+${list.length}`; d.appendChild(b); }
              grid.appendChild(d);
            }
          }
          card.appendChild(grid);
          const tks=document.createElement('div'); tks.className='tickets'; tks.innerHTML=`<h3>Pendências / Chamados — ${nome}</h3>`;
          const lista=(bundle.snapshot.quadros[quadroKey].chamados||[]).filter(c=>c.bloco===nome);
          if(!lista.length){ const emp=document.createElement('div'); emp.className='tmeta'; emp.textContent='Sem chamados.'; tks.appendChild(emp);} else {
            lista.sort((a,b)=>a.id.localeCompare(b.id)).forEach(ch=>{
              const item=document.createElement('div'); item.className='ticket';
              const pav=(21-ch.pavIndex).toString().padStart(2,'0'); const num=`${21-ch.pavIndex}${(ch.aptIndex+1).toString().padStart(2,'0')}`;
              item.innerHTML=`<span class="tid">${escapeHTML(ch.id)}</span><div class="ttext"><div><strong>Apto ${num}</strong> — ${escapeHTML(ch.texto||'')}</div><div class="tmeta">Pav ${pav} • Coluna ${(ch.aptIndex+1).toString().padStart(2,'0')}</div></div>`;
              tks.appendChild(item);
            });
          }
          const marker = quadroKey==='eletrica'
            ? wrap.querySelector('.sectionTitle:nth-of-type(1)')
            : wrap.querySelector('.sectionTitle:nth-of-type(2)');
          marker.after(card);
        }
      }

      renderQuadro('eletrica');
      renderQuadro('hidraulica');

      const box=byId('legendTickets');
      const allChamados=[...bundle.snapshot.quadros.eletrica.chamados, ...bundle.snapshot.quadros.hidraulica.chamados];
      if(!allChamados.length){ box.innerHTML=''; }
      else{
        const itens=allChamados.slice().sort((a,b)=>a.id.localeCompare(b.id)).map(ch=>{
          const num=`${21-ch.pavIndex}${(ch.aptIndex+1).toString().padStart(2,'0')}`;
          return `<li><strong>${escapeHTML(ch.id)}</strong>: ${escapeHTML(ch.texto||'')} <span style=\"color:#64748b\">(${escapeHTML(ch.bloco)} • Apto ${num})</span></li>`;
        }).join('');
        box.innerHTML=`<h4>Legenda de chamados — Geral</h4><ul>${itens}</ul>`;
      }

      const aside=byId('aside');
      const last= (bundle.history||[]).slice(-10);
      aside.querySelector('pre').textContent = last.length ? last.map(e=>`${e.ts} · ${e.type} · ${e.who||''}`).join('\n') : 'Sem eventos.';
      aside.querySelector('.meta').innerHTML = `Autor: <strong>${escapeHTML(bundle.meta.author||'-')}</strong> • Atualizado: ${escapeHTML(bundle.meta.updatedAt||'-')}`;

      // ---- Self-tests (sanidade para bundle zerado) ----
      (function selfTests(){
        const out=[]; let okCount=0;
        const snap=bundle.snapshot;
        function assert(name, cond){ if(!cond){ out.push(`✗ ${name}`);} else { okCount++; } }
        // 1) JSON v4 carregado
        assert('JSON carrega e schema v4', snap && (bundle.schema==='v4' || bundle.schema==null));
        // 2) Histórico vazio
        assert('Histórico vazio', (bundle.history||[]).length===0);
        // 3) Sem chamados abertos
        const totalChamados=(snap.quadros.eletrica.chamados?.length||0)+(snap.quadros.hidraulica.chamados?.length||0);
        assert('Sem chamados abertos', totalChamados===0);
        // 4) Todos os apartamentos válidos iniciam como NV
        function countValidNV(m){
          let nv=0, valid=0; 
          for(let i=0;i<m.length;i++){
            for(let a=0;a<m[i].length;a++){
              if(m[i][a]!=='xx'){ valid++; if(m[i][a]==='nv') nv++; }
            }
          }
          return {nv, valid};
        }
        const mEL1=snap.quadros.eletrica.blocos['Bloco 1'];
        const mEL2=snap.quadros.eletrica.blocos['Bloco 2'];
        const mHI1=snap.quadros.hidraulica.blocos['Bloco 1'];
        const mHI2=snap.quadros.hidraulica.blocos['Bloco 2'];
        const arr=[mEL1,mEL2,mHI1,mHI2].map(countValidNV);
        arr.forEach((x,idx)=>assert(`Bloco ${idx+1} começa todo NV`, x.nv===x.valid && x.valid>0));
        const el=document.getElementById('selftests');
        if(out.length){ el.textContent = `Self-tests: FALHOU — ${out.length} erro(s)\n`+out.join('\n'); el.style.color='#b91c1c'; }
        else { el.textContent = `Self-tests: OK — ${okCount} asserções`; el.style.color='#065f46'; }
      })();
    }

    render();
  </script>
</body>
</html>
