<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quadro Branco — Entregas (Elétrica / Hidráulica)</title>
  <meta name="description" content="TV-ready. Dois quadros separados: Equipe Elétrica e Equipe Hidráulica. Cada quadro tem 2 blocos lado a lado. Clique alterna status, chamados por apto, exportar JSON. Logo fixa. Sem import: atualização via GitHub." />
  <style>
    :root{
      --bg:#ffffff; --text:#0f172a; --muted:#475569; --line:#e2e8f0; --head:#f8fafc;
      --ok:#16a34a; --pl:#eab308; --pm:#f97316; --nc:#ef4444; --nv:#cbd5e1; --btn:#0ea5e9;
      --badge:#ffffff; --badgeText:#0f172a;
      --segBg:#e6f4ff; --segBorder:#b6e0ff; --segText:#075985;
    }
    *{box-sizing:border-box}
    html,body{margin:0;min-height:100%;background:var(--bg);color:var(--text);font:16px/1.35 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:12px 16px;border-bottom:2px solid var(--line);position:sticky;top:0;background:var(--bg);z-index:10}
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .brand img{height:36px;width:auto;object-fit:contain}
    .brand h1{margin:0;font-size:22px;font-weight:800;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Segmented control para alternar quadros */
    .seg{display:flex;border:2px solid var(--segBorder);border-radius:12px;overflow:hidden}
    .seg button{appearance:none;border:0;background:transparent;padding:8px 12px;font-weight:700;color:var(--segText);cursor:pointer}
    .seg button.active{background:var(--segBg)}

    .tools{display:flex;gap:8px;flex-wrap:wrap}
    button{appearance:none;border:none;background:var(--btn);color:#07263a;padding:8px 10px;border-radius:10px;font-weight:700;cursor:pointer}
    .ghost{background:transparent;border:1px solid var(--line);color:var(--muted)}

    .wrap{display:grid;grid-template-columns:1fr 1fr;gap:20px;padding:18px}
    .card{border:2px solid var(--line);border-radius:18px;padding:14px}
    .card h2{margin:0 0 8px 0;font-size:18px}

    .kpi{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 10px 0}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:14px;color:var(--muted);background:var(--head)}

    /* grade vertical 21 x (até) 4 aptos */
    .grid{display:grid;grid-template-columns:76px repeat(4, 1fr);gap:8px}
    .cell,.head{border:1px solid var(--line);border-radius:12px;padding:0;text-align:center}
    .head{background:var(--head);font-weight:700;padding:10px}
    .pv{font-variant-numeric:tabular-nums;font-weight:800}

    .apto{position:relative;height:48px;display:flex;align-items:center;justify-content:center;font-weight:800;border-width:2px;cursor:pointer;user-select:none;transition:transform .06s ease}
    .apto:active{transform:scale(.98)}
    .apto .label{font-size:14px;background:rgba(255,255,255,.85);padding:2px 6px;border-radius:8px;mix-blend-mode:screen}
    .badge{position:absolute;top:6px;right:6px;background:var(--badge);color:var(--badgeText);border:1px solid var(--line);border-radius:10px;font-size:11px;padding:1px 6px;font-weight:800}

    .apto.nv{background:var(--nv);color:#0f172a}
    .apto.ok{background:var(--ok);color:#0b1610}
    .apto.pl{background:var(--pl);color:#3a2c07}
    .apto.pm{background:var(--pm);color:#fff}
    .apto.nc{background:var(--nc);color:#fff}

    .apto.disabled{background:transparent;border:1px dashed var(--line);color:var(--muted);cursor:default}
    .apto.disabled .label{background:transparent}

    /* Chamados */
    .tickets{margin-top:12px;border-top:1px dashed var(--line);padding-top:10px}
    .tickets h3{margin:0 0 8px 0;font-size:14px;color:var(--muted)}
    .ticket{display:flex;gap:8px;align-items:flex-start;border:1px solid var(--line);border-radius:10px;padding:8px;margin:6px 0;background:var(--head)}
    .tid{font-weight:800;color:#0f172a;background:#fff;border:1px solid var(--line);border-radius:8px;padding:2px 6px}
    .tmeta{font-size:12px;color:var(--muted)}
    .ttext{flex:1}
    .ticket button{background:transparent;border:1px solid var(--line);color:#ef4444;border-radius:8px;padding:4px 6px;font-weight:800}

    /* Rodapé */
    footer{border-top:2px solid var(--line);padding:8px 14px 60px 14px;color:var(--muted);font-size:13px}
    .legend{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;opacity:.95}
    .dot{width:12px;height:12px;border-radius:3px;display:inline-block;margin-right:6px}
    .legend small{font-size:12px;color:#64748b}
    .legendTickets{margin-top:12px;border-top:1px dashed var(--line);padding-top:10px}
    .legendTickets h4{margin:0 0 8px 0;color:#334155}
    .legendTickets ul{margin:0;padding-left:18px}

    @media (min-width:1600px){ html{font-size:18px} .apto{height:54px} }
    @media (min-width:2400px){ html{font-size:22px} .apto{height:60px} }
    @media print{ header{display:none} .card{break-inside:avoid} footer{display:none} }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img alt="Logo" src="Assets/logo.jpg" onerror="this.style.display='none'"/>
      <h1>Quadro Branco — Entregas por Cores</h1>
    </div>
    <div class="seg" role="tablist" aria-label="Selecionar quadro">
      <button id="tabEle" role="tab" aria-selected="true" class="active">Equipe Elétrica</button>
      <button id="tabHid" role="tab" aria-selected="false">Equipe Hidráulica</button>
    </div>
    <div class="tools">
      <button id="btnExport">Baixar JSON</button>
      <button class="ghost" id="btnZerar">Zerar quadro</button>
      <button class="ghost" id="btnNovoChamado">Novo chamado</button>
    </div>
  </header>

  <main class="wrap" id="wrap"></main>

  <footer>
    <div class="legend">
      <span><span class="dot" style="background:var(--ok)"></span><strong>OK</strong> <small>entregue</small></span>
      <span><span class="dot" style="background:var(--pl)"></span><strong>PL</strong> <small>pendência leve</small></span>
      <span><span class="dot" style="background:var(--pm)"></span><strong>PM</strong> <small>pendência média</small></span>
      <span><span class="dot" style="background:var(--nc)"></span><strong>NC</strong> <small>não conforme</small></span>
      <span><span class="dot" style="background:var(--nv)"></span><strong>NV</strong> <small>não vistoriado</small></span>
    </div>
    <div class="legendTickets" id="legendTickets"></div>
  </footer>

  <script>
    // ===== Config =====
    const PAV = 21;         // 21º com 2 coberturas
    const APT = 4;          // Máx. por pavimento
    const ORDER = ["nv","ok","pl","pm","nc"]; // ciclo
    const LABEL = { nv:"NV", ok:"OK", pl:"PL", pm:"PM", nc:"NC", xx:"--" };

    // Aptos por pavimento (idx 0 = 21º)
    const aptosNoPav = (idx)=> (PAV - idx) === 21 ? 2 : 4;
    const aptNumber = (pav, apIdx)=> `${pav}${(apIdx+1).toString().padStart(2,'0')}`; // 1->101, 12->1203
    const emptyMatriz = ()=> Array.from({length:PAV},(_,i)=> Array.from({length:APT},(_,a)=> a < aptosNoPav(i) ? 'nv' : 'xx'));

    // Estrutura com 2 quadros independentes (logo fixa via HTML)
    const DEFAULTS = {
      current: 'eletrica',
      quadros: {
        eletrica: { nome: 'Equipe Elétrica', blocos: { 'Bloco 1': emptyMatriz(), 'Bloco 2': emptyMatriz() }, chamados: [] },
        hidraulica: { nome: 'Equipe Hidráulica', blocos: { 'Bloco 1': emptyMatriz(), 'Bloco 2': emptyMatriz() }, chamados: [] }
      }
    };

    function normalize(obj){
      const out = JSON.parse(JSON.stringify(DEFAULTS));
      if(!obj || typeof obj !== 'object') return out;
      out.current = (obj.current==='hidraulica') ? 'hidraulica' : 'eletrica';
      for(const key of ['eletrica','hidraulica']){
        const q = obj.quadros && obj.quadros[key];
        if(q && typeof q==='object'){
          out.quadros[key].nome = typeof q.nome==='string' && q.nome.trim()? q.nome : out.quadros[key].nome;
          // Blocos
          if(q.blocos && typeof q.blocos==='object'){
            for(const [bn, mat] of Object.entries(q.blocos)){
              out.quadros[key].blocos[bn] = Array.from({length:PAV},(_,i)=>{
                const row = Array.isArray(mat?.[i]) ? mat[i] : [];
                const qv = aptosNoPav(i);
                return Array.from({length:APT},(_,a)=>{
                  if(a>=qv) return 'xx';
                  const v = row[a];
                  return (v==='ok'||v==='pl'||v==='pm'||v==='nc'||v==='nv') ? v : 'nv';
                });
              });
            }
          }
          // Chamados
          const arr = Array.isArray(q.chamados) ? q.chamados : [];
          out.quadros[key].chamados = arr.filter(c=> c && typeof c==='object').map(c=> ({
            id: String(c.id||'').trim()||'SEM-ID',
            bloco: (c.bloco && out.quadros[key].blocos[c.bloco]) ? c.bloco : 'Bloco 1',
            pavIndex: Math.max(0, Math.min(PAV-1, parseInt(c.pavIndex,10)||0)),
            aptIndex: Math.max(0, Math.min(APT-1, parseInt(c.aptIndex,10)||0)),
            texto: typeof c.texto==='string' ? c.texto : ''
          }));
        }
      }
      return out;
    }

    // Estado
    let state = JSON.parse(JSON.stringify(DEFAULTS));
    try{ const raw = localStorage.getItem('quadro_entregas_v2'); if(raw) state = normalize(JSON.parse(raw)); }catch(_){ state = JSON.parse(JSON.stringify(DEFAULTS)); }

    // Helpers DOM
    const wrap = document.getElementById('wrap');
    const tabEle = document.getElementById('tabEle');
    const tabHid = document.getElementById('tabHid');

    function save(){ try{ localStorage.setItem('quadro_entregas_v2', JSON.stringify(state)); }catch(_){ /* ignore */ } }
    function chip(t){ return `<span class=\"chip\">${t}</span>` }
    function head(t){ const d=document.createElement('div'); d.className='head cell'; d.textContent=t; return d; }

    function count(m){ const r={ok:0,pl:0,pm:0,nc:0,nv:0}; (m||[]).flat().forEach(s=>{ if(r[s]!=null) r[s]++; }); return r; }

    function chamadosFor(quadro, bloco, i, a){
      const arr = Array.isArray(state.quadros[quadro].chamados) ? state.quadros[quadro].chamados : [];
      return arr.filter(c=> c.bloco===bloco && c.pavIndex===i && c.aptIndex===a);
    }

    function render(){
      // atualiza abas
      tabEle.classList.toggle('active', state.current==='eletrica');
      tabEle.setAttribute('aria-selected', state.current==='eletrica');
      tabHid.classList.toggle('active', state.current==='hidraulica');
      tabHid.setAttribute('aria-selected', state.current==='hidraulica');

      wrap.innerHTML = '';
      const q = state.quadros[state.current];

      Object.entries(q.blocos).forEach(([nome, matriz])=>{
        const card = document.createElement('section');
        card.className = 'card';
        const h2 = document.createElement('h2'); h2.textContent = `${q.nome} — ${nome}`; card.appendChild(h2);

        const kpi = document.createElement('div'); kpi.className = 'kpi';
        const s = count(matriz);
        kpi.innerHTML = [chip(`OK: ${s.ok}`), chip(`PL: ${s.pl}`), chip(`PM: ${s.pm}`), chip(`NC: ${s.nc}`), chip(`NV: ${s.nv}`)].join('');
        card.appendChild(kpi);

        const grid = document.createElement('div'); grid.className = 'grid';
        grid.appendChild(head('Pav'));
        for(let a=1;a<=APT;a++) grid.appendChild(head(String(a).padStart(2,'0')));

        for(let i=0;i<PAV;i++){
          const pav = (PAV - i).toString().padStart(2,'0');
          grid.appendChild(head(pav));
          const valid = aptosNoPav(i);
          for(let a=0;a<APT;a++){
            const st = matriz[i][a];
            const num = aptNumber(PAV - i, a);
            const disabled = (a>=valid) || st==='xx';
            const d = document.createElement('div');
            d.className = `cell apto ${disabled? 'disabled' : st}`;
            d.title = disabled ? `Pav ${pav} • Inexistente` : `Apto ${num} • ${LABEL[st]}`;
            d.innerHTML = `<span class=\"label\">${disabled? '\u2014' : `${num} · ${LABEL[st]}`}</span>`;
            if(!disabled){
              d.addEventListener('click', ()=>{
                const cur = state.quadros[state.current].blocos[nome][i][a];
                const nx = ORDER[(ORDER.indexOf(cur)+1)%ORDER.length];
                state.quadros[state.current].blocos[nome][i][a] = nx; save(); render();
              });
              const list = chamadosFor(state.current, nome, i, a);
              if(list.length){
                const b = document.createElement('div'); b.className='badge';
                b.textContent = list.length===1 ? list[0].id : `+${list.length}`;
                d.appendChild(b);
              }
            }
            grid.appendChild(d);
          }
        }

        card.appendChild(grid);

        // Chamados por bloco
        const tks = document.createElement('div'); tks.className='tickets';
        tks.innerHTML = `<h3>Pendências / Chamados — ${nome}</h3>`;
        const lista = (state.quadros[state.current].chamados||[]).filter(c=> c.bloco===nome);
        if(!lista.length){ const emp=document.createElement('div'); emp.className='tmeta'; emp.textContent='Sem chamados.'; tks.appendChild(emp); }
        else {
          lista.sort((a,b)=> a.id.localeCompare(b.id)).forEach(ch=>{
            const item = document.createElement('div'); item.className='ticket';
            const pav = (PAV - ch.pavIndex).toString().padStart(2,'0');
            const num = aptNumber(PAV - ch.pavIndex, ch.aptIndex);
            item.innerHTML = `<span class=\"tid\">${ch.id}</span>
              <div class=\"ttext\">
                <div><strong>Apto ${num}</strong> — ${escapeHTML(ch.texto||'')}</div>
                <div class=\"tmeta\">Pav ${pav} • Coluna ${(ch.aptIndex+1).toString().padStart(2,'0')}</div>
              </div>`;
            const del = document.createElement('button'); del.textContent='Excluir';
            del.addEventListener('click',()=>{ removerChamado(ch.id); });
            item.appendChild(del);
            tks.appendChild(item);
          });
        }
        card.appendChild(tks);

        wrap.appendChild(card);
      });

      renderLegendaGeral();
    }

    function renderLegendaGeral(){
      const box = document.getElementById('legendTickets');
      const arr = state.quadros[state.current].chamados || [];
      if(!arr.length){ box.innerHTML=''; return; }
      const itens = arr.slice().sort((a,b)=> a.id.localeCompare(b.id)).map(ch=>{
        const num = aptNumber(PAV - ch.pavIndex, ch.aptIndex);
        return `<li><strong>${ch.id}</strong>: ${escapeHTML(ch.texto||'')} <span style=\"color:#64748b\">(${escapeHTML(ch.bloco)} • Apto ${num})</span></li>`;
      }).join('');
      box.innerHTML = `<h4>Legenda de chamados — ${state.quadros[state.current].nome}</h4><ul>${itens}</ul>`;
    }

    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

    // ===== Botões =====
    document.getElementById('btnExport').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='code.json';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    document.getElementById('btnZerar').addEventListener('click', ()=>{
      if(!confirm('Zerar status e chamados apenas do quadro atual?')) return;
      const cur = state.current;
      state.quadros[cur].blocos['Bloco 1'] = emptyMatriz();
      state.quadros[cur].blocos['Bloco 2'] = emptyMatriz();
      state.quadros[cur].chamados = [];
      save(); render();
    });

    document.getElementById('btnNovoChamado').addEventListener('click', ()=>{
      const cur = state.current;
      const q = state.quadros[cur];
      try{
        const bloco = prompt(`Bloco (${Object.keys(q.blocos).join(' / ')}):`); if(!bloco) return;
        if(!q.blocos[bloco]){ alert('Bloco não encontrado.'); return; }
        const pavStr = prompt('Pavimento (21 a 1):'); if(!pavStr) return; const pav = parseInt(pavStr,10); if(!(pav>=1&&pav<=21)){ alert('Pavimento inválido'); return; }
        const aptStr = prompt('Apto (01 a 04):'); if(!aptStr) return; const apt = parseInt(aptStr,10); if(!(apt>=1&&apt<=4)){ alert('Apto inválido'); return; }
        const i = PAV - pav; const a = apt-1; if(a>=aptosNoPav(i)){ alert('Este apartamento não existe neste pavimento.'); return; }
        const id = prompt('ID do chamado (ex.: CH-101):'); if(!id) return;
        const texto = prompt('Descrição resumida da pendência:') || '';
        q.chamados.push({ id, bloco, pavIndex:i, aptIndex:a, texto });
        save(); render();
      }catch(e){ console.warn(e); }
    });

    // Abas
    tabEle.addEventListener('click', ()=>{ state.current='eletrica'; save(); render(); });
    tabHid.addEventListener('click', ()=>{ state.current='hidraulica'; save(); render(); });

    // Self-tests (console)
    (function tests(){
      console.group('Self-tests');
      const legacy = { quadros:{ eletrica:{ blocos:{'Bloco 1': emptyMatriz()}, /* sem chamados */ }, hidraulica:{ blocos:{'Bloco 2': emptyMatriz()}, chamados:{foo:'bar'} } } };
      const n = normalize(legacy);
      console.assert(Array.isArray(n.quadros.eletrica.chamados), 'T1: chamados elétrica array');
      console.assert(Array.isArray(n.quadros.hidraulica.chamados), 'T2: chamados hidráulica array');
      console.assert(n.current==='eletrica', 'T3: current default elétrica');
      console.log('OK — self-tests.');
      console.groupEnd();
    })();

    // Inicial
    render();
  </script>
</body>
</html>





